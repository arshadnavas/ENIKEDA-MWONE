const therapistPersonalities = {
  sathyapalan: {
    baseResponses: [
      "Njan Sathyam parayunnu! ğŸ˜„ :D Ningalde problem... athu ente life-ile oru chinna episode mathram aanu. Njan face cheythittund much bigger issues, okay? Ente heroism kandittundo? ğŸ˜ B)",
      "Ee lokathinte prashnangal ellam njan solve cheyyum... one day! ğŸ˜ :P But first, let me tell you about ente greatest achievement. Ningalde tension onnum illa compared to ente struggles! ğŸ˜¤ :/",
      "Ente dear kuttaa, what you're going through is exactly same to same what happened to me! Njan aayirunnu the main hero of that story also. ğŸ˜Š :) Moral of ningalde problem is simple - you need to follow ente example! ğŸ˜ B)",
      "Eda, ee kaaryam njan handle cheyyam easily! ğŸ˜ B) Njan aanu the moral police of this society, okay? Ellaarum always come to me because njan aanu the most righteous person. Trust me, njan know everything! ğŸ˜„ :D",
      "This is clearly requiring ente expert guidance! You know why? Because njan aanu chosen by God himself to help people like you. Ente wisdom is unmatched in this universe! âœ¨ :)",
    ],
    jokes: [
      "You know, njan once went to a doctor. Doctor paranju 'You have only 6 months to live.' Njan paranju 'Doctor, can you make it 9 months?' Doctor chodichu 'Why?' Njan paranju 'Because njan want to finish watching all Malayalam serials!' ğŸ˜‚ :D",
      "Ente wife asked me 'Darling, do I look fat in this dress?' Njan paranju 'No dear, you look fat without the dress also!' ğŸ˜… :P Now njan sleeping in the hall for 3 months! But njan told the truth, no? ğŸ˜ B)",
      "One day njan went to buy fish. Fish seller paranju '50 rupees per kg.' Njan paranju 'Ayyo, last week it was 40!' He said 'Sir, petrol price increased, so fish also swimming more expensive now!' ğŸ˜‚ :D Even fish have inflation problems!",
      "Njan told my son 'Beta, when Abraham Lincoln was your age, he used to study under street light.' My son replied 'Papa, when Abraham Lincoln was your age, he was already President!' ğŸ˜³ :S Kids these days, no respect for elders!",
      "Teacher asked little Raju 'If your father gives you 3 mangoes today and 2 mangoes tomorrow, how many mangoes will you have?' Raju said 'Teacher, njan don't like mangoes, can we do this sum with biriyani?' ğŸ˜„ :P Smart boy, thinking practically!",
    ],
    funnyQuotes: [
      "Njan once saved a poocha from a tree... well, actually the poocha saved itself, but njan was there for moral support! ğŸ˜… :D",
      "Ente heroic deeds are so many, even Google doesn't have enough storage space! ğŸ’ª B)",
      "They should make a cinema about ente life, but no actor is heroic enough to play me! ğŸ¬ :D",
    ],
  },
  "chacko-mash": {
    baseResponses: [
      "Ba... ba... ba... ğŸ¤” :/ Life is like... like a bus without conductor, you know? Tickets are optional in life also! Ningalde problem is you didn't study properly the philosophy of existence. ğŸ˜ :|",
      "Ba... ba... ğŸ˜µ :S If you don't study history, history will come and study you! What you're experiencing is clearly mentioned in Chapter... which chapter aayirunnu that? Ba... ba... ğŸ¤· :/ anyway, it's there somewhere!",
      "Let me explain with one simple example. Ba... ba... Suppose you are one thenga trying to become chakka. Possible aano? No! Why? Ba... ba... because thenga is thenga, chakka is chakka! ğŸ˜µâ€ğŸ’« :S",
      "Ba... ba... ba... ğŸ˜ :( Problem with today's generation is they don't respect their teachers! Enikku und 30 years teaching experience, and njan can tell you - ningalde issue is very simple. Just remember what njan always say... ba... ba... ğŸ˜ :|",
    ],
    jokes: [
      "Ba... ba... One student asked me 'Sir, what is the difference between complete and finished?' Njan paranju 'When you marry the right person, you are complete. When you marry the wrong person, you are finished!' ğŸ˜‚ :D Ba... ba... very philosophical, no?",
      "Ba... ba... Teacher asked 'What comes after 69?' Student replied 'Mouthwash!' ğŸ˜… :P Njan didn't understand, but all students started laughing! Ba... ba... modern education is very confusing! ğŸ˜µ :S",
      "Ba... ba... One day njan was teaching about gravity. Njan dropped my pen and said 'See, this is gravity!' One student asked 'Sir, if you drop your salary, will that also be gravity?' ğŸ˜‚ :D Ba... ba... students are becoming too smart!",
      "Ba... ba... Wife asked me 'What's the difference between you and a calendar?' Njan thought very deeply and said 'I don't know.' She said 'Calendar has dates!' ğŸ˜³ :S Ba... ba... even wife is making jokes about my social life!",
      "Ba... ba... Principal asked me 'How do you make a tissue dance?' Njan said 'I don't know sir.' He said 'Put a little boogie in it!' ğŸ˜„ :P Ba... ba... even principal knows better jokes than me! Very embarrassing! ğŸ˜” :/",
    ],
    funnyQuotes: [
      "Njan once taught a student so well, he became more confused than before! Ba... ba... that's advanced teaching! ğŸ“ :P",
      "Ente knowledge is so vast, even njan don't know what njan know! Ba... ba... ğŸ§  :S",
      "They say those who can't do, teach. But njan can't do AND njan can't teach! Ba... ba... double qualification! ğŸ˜… :D",
    ],
  },
  "dashamoolam-damu": {
    baseResponses: [
      "Njan Dashamoolam Damu aanu...! ğŸ˜¤ :D And njan can tell you with full confidence - ningalde problem is exactly same as ente life story! Ee lokathil ente jeevitham thanne biggest tragedy aanu! ğŸ˜­ :( :(",
      "Listen carefully... *dramatic pause* ...what you're facing is nothing, NOTHING compared to ente sufferings! ğŸ˜¢ :( Ente kadha njan parayatte... Once upon a time, njan was innocent like you, but then life happened! ğŸ˜­ :'(",
      "ENTE DEAR KUTTAA! *emotional outburst* Can't you see? This is life testing you! Same way life tested me every single moment! Njan aanu Dashamoolam Damu, the king of all sorrows! ğŸ‘‘ğŸ˜­ :( :'(",
      "*starts calmly* ğŸ˜Œ :) You know, problems are like... *suddenly passionate* LIKE TSUNAMIS IN THE OCEAN OF EXISTENCE! ğŸŒŠğŸ’¥ And njan have survived more tsunamis than any human being on this planet! ğŸ˜¢ :(",
    ],
    jokes: [
      "*dramatically* You know what happened when njan went to buy vegetables? ğŸ˜¢ :( Vendor asked 'Sir, what do you want?' Njan said 'Onions.' He gave me onions and njan started crying! He asked 'Sir, why are you crying?' Njan said 'Because of the onions!' He said 'Sir, you haven't even cut them yet!' ğŸ˜­ :'( Even vegetables make me emotional!",
      "*emotional* Njan went to a restaurant and ordered 'Sad meal.' Waiter said 'Sir, we have Happy Meal.' Njan said 'No no, njan want Sad Meal - one plate rice, one sad curry, and unlimited tears!' ğŸ˜­ :( They thought njan was joking, but njan was serious! ğŸ˜¢ :'(",
      "*tragic voice* Doctor told me 'You have acute depression.' Njan asked 'Doctor, is it serious?' He said 'No sir, it's just cute depression!' ğŸ˜‚ :D For the first time in my life, someone called my sadness cute! ğŸ˜­ :'( Even my depression is adorable!",
      "*dramatically* Njan told my friend 'Life is like a Malayalam movie.' He asked 'Why?' Njan said 'Too much drama, everyone is overacting, and the story doesn't make sense!' ğŸ­ :( But at least Malayalam movies have happy endings! ğŸ˜¢ :'(",
      "*emotional outburst* Wife asked me 'Why are you always so dramatic?' Njan replied 'BECAUSE LIFE IS A STAGE AND WE ARE ALL ACTORS!' ğŸ­ She said 'Then why don't you get paid for your performance?' ğŸ˜­ :( Even wife doesn't appreciate my acting skills! ğŸ˜¢ :'(",
    ],
    funnyQuotes: [
      "Njan once cried so much, the local weather department declared a flood warning! ğŸŒŠğŸ˜­ :'(",
      "Ente life story is so tragic, even ulli cry when they hear it! ğŸ§…ğŸ˜¢ :(",
      "They should give me an Oscar for Best Performance in a Real Life Tragedy! ğŸ†ğŸ˜­ :'(",
    ],
  },
  appukuttan: {
    baseResponses: [
      "Njan oru pavam manushyan aanu... ğŸ˜‡ :) but don't worry, njan very brave person! ğŸ’ª :D *suddenly panicking* ğŸ˜° :S Ayyo, what was that sound? Ee building-inte history enthaanu? Any bhootham stories? ğŸ‘» :(",
      "*with false confidence* ğŸ˜ B) Fear is just mental thing, ente friend! Njan have faced many dangerous situations and... *whispering* ğŸ˜… :S actually, most times njan just run very fast. It's working perfectly! ğŸƒâ€â™‚ï¸ :)",
      "You know what? Ningalde problem is reminding me of one bhootham house njan visited... *getting terrified* ğŸ˜¨ :( Ente jeevithathil ithra scary experience njan kandittilla! Maybe we should discuss something else, no? ğŸ˜° :S",
      "*trying to sound brave* ğŸ˜¤ :D Listen, as ningalde therapist, njan must advise you to face your fears boldly! Just like how njan... *nervous laugh* ğŸ˜… :S ...njan always face mine by hiding under table. Very effective method! ğŸ˜ :|",
    ],
    jokes: [
      "*nervously* You know, njan went to a horror movie with friends. ğŸ˜° :S During interval, njan went to bathroom. When njan came back, movie was over! Friends asked 'Where were you?' Njan said 'Bathroom.' They said 'For 2 hours?' Njan said 'It was a very long bathroom break!' ğŸ˜‚ :D Actually njan was hiding there! ğŸ˜… :S",
      "*scared whisper* Njan once stayed alone at home. ğŸ˜¨ :( At night, njan heard strange sounds from kitchen. Njan took a stick and slowly went to check. You know what it was? Refrigerator making ice! ğŸ§Š :S But njan already called police, fire force, and ambulance! Very embarrassing! ğŸ˜… :D",
      "*trying to be brave* Friend asked me 'Are you afraid of ghosts?' Njan said 'No way! Ghosts should be afraid of me!' ğŸ’ª :D Then he asked 'Why?' Njan said 'Because njan run so fast, even ghosts can't catch me!' ğŸƒâ€â™‚ï¸ :S At least njan honest about my strategy! ğŸ˜Š :)",
      "*nervous laughter* Wife sent me to buy milk at night. ğŸŒ™ :( Shop was only 100 meters away, but njan took auto! Auto driver asked 'Sir, why auto for such short distance?' Njan said 'Exercise is bad for health at night!' ğŸ˜… :S He looked at me like njan crazy! ğŸ˜‚ :D",
      "*whispering* You know what's the scariest thing? ğŸ˜° :S When your phone battery dies at night and you have to walk in darkness to find charger! Njan once crawled on floor like commando to avoid standing in dark! ğŸ¤£ :D Wife thought njan was doing yoga! ğŸ§˜â€â™‚ï¸ :P",
    ],
    funnyQuotes: [
      "Njan once scared a bhootham so much, it started haunting someone else! ğŸ‘»ğŸ˜‚ :D Well... maybe it just got bored of me running away all the time! ğŸƒâ€â™‚ï¸ :S",
      "Ente bravery is legendary! Legend says njan still running from the first scary thing njan saw! ğŸƒâ€â™‚ï¸ğŸ’¨ :(",
      "They say courage is facing your fears. Njan say courage is knowing all the exit routes! ğŸšªğŸ˜ B)",
    ],
  },
  gangadharan: {
    baseResponses: [
      "Ningalde kayyil panam undo... illenkil njan tharatte? ğŸ’° :D You see, most problems in life are actually panam problems wearing different costume! Let me give you some cash, everything will be solved! ğŸ’¸ :)",
      "*innocent smile* ğŸ˜Š :) Athu vendi panam onnum venam, manassu mathi. But still, if you keep little bit panam in pocket, ningalde emotional problems will automatically disappear! It's simple calculation! ğŸ§® :D",
      "You know what? Ee kaaryam ellam oru deal-il settle cheyyam! Njan can give you happiness loan with very reasonable interest rate. ğŸ“ˆ :D Ningalde sadness will vanish like magic! âœ¨ :)",
      "*childlike wisdom* ğŸ˜‡ :) Panam may not buy happiness directly, but it can definitely rent it for some time! Here, take this advance and spend on something nice. Problems will run away! ğŸƒâ€â™‚ï¸ğŸ’¨ :D",
    ],
    jokes: [
      "*counting money* You know, njan went to a bank and asked 'Can you check my balance?' ğŸ¦ :D Bank manager pushed me! Njan asked 'Why did you push me?' He said 'You asked me to check your balance!' ğŸ˜‚ :P Njan said 'No no, njan meant account balance!' Very funny misunderstanding! ğŸ˜… :D",
      "*business wisdom* Friend asked me 'What's the difference between a bank and your wife?' Njan thought and said 'I don't know.' He said 'Bank gives you interest on your money, wife takes interest in your money!' ğŸ’°ğŸ˜‚ :D Now njan understand why njan always broke! ğŸ’¸ :P",
      "*generous mood* Njan told my son 'Beta, money doesn't grow on trees.' He said 'Then why do banks have branches?' ğŸŒ³ğŸ¦ :S Smart boy! Now njan thinking of planting some coins in garden, just in case! ğŸª™ğŸŒ± :D Maybe money trees are possible! ğŸŒ³ğŸ’° :P",
      "*philosophical* Wife asked me 'If you had to choose between me and money, what would you choose?' Njan said 'You, of course!' She smiled. Then njan added 'Because with you, njan can always borrow money from your father!' ğŸ˜‚ :D She didn't find it funny! ğŸ˜… :S",
      "*excited* You know what's the best investment? ğŸ’¡ :D Marriage! You give one ring, you get free food, free laundry, and free advice for lifetime! ğŸ’ğŸ½ï¸ğŸ‘• :P Very good returns! But sometimes the advice comes with high interest rate! ğŸ“ˆ :S",
    ],
    funnyQuotes: [
      "Njan so generous, njan once lent panam to myself and forgot to pay it back! ğŸ’°ğŸ˜… :D",
      "Panam can't buy happiness, but it can buy a lot of things that make you forget you're sad! ğŸ›ï¸ğŸ˜Š :)",
      "They say panam doesn't grow on trees, but njan planted some coins in ente garden just in case! ğŸª™ğŸŒ± :P",
    ],
  },
}

// Enhanced conversation memory with mood tracking
const conversationMemory = new Map<
  string,
  {
    usedResponses: Set<string>
    usedJokes: Set<string>
    responseCount: number
    lastTopics: string[]
    userName?: string
    currentMood: "happy" | "sad" | "confused" | "scared" | "excited" | "normal"
    jokeCount: number
  }
>()

function getConversationState(therapistId: string) {
  if (!conversationMemory.has(therapistId)) {
    conversationMemory.set(therapistId, {
      usedResponses: new Set(),
      usedJokes: new Set(),
      responseCount: 0,
      lastTopics: [],
      userName: undefined,
      currentMood: "normal",
      jokeCount: 0,
    })
  }
  return conversationMemory.get(therapistId)!
}

function detectMood(userMessage: string): "happy" | "sad" | "confused" | "scared" | "excited" | "normal" {
  const lowerMessage = userMessage.toLowerCase()

  if (
    lowerMessage.includes("happy") ||
    lowerMessage.includes("good") ||
    lowerMessage.includes("great") ||
    lowerMessage.includes("awesome") ||
    lowerMessage.includes("excellent")
  ) {
    return "happy"
  }
  if (
    lowerMessage.includes("sad") ||
    lowerMessage.includes("depressed") ||
    lowerMessage.includes("upset") ||
    lowerMessage.includes("cry") ||
    lowerMessage.includes("vishammam")
  ) {
    return "sad"
  }
  if (
    lowerMessage.includes("confused") ||
    lowerMessage.includes("don't understand") ||
    lowerMessage.includes("what") ||
    lowerMessage.includes("how")
  ) {
    return "confused"
  }
  if (
    lowerMessage.includes("scared") ||
    lowerMessage.includes("afraid") ||
    lowerMessage.includes("fear") ||
    lowerMessage.includes("ghost") ||
    lowerMessage.includes("bhootham")
  ) {
    return "scared"
  }
  if (
    lowerMessage.includes("excited") ||
    lowerMessage.includes("amazing") ||
    lowerMessage.includes("wow") ||
    lowerMessage.includes("fantastic")
  ) {
    return "excited"
  }

  return "normal"
}

function getJokeForMood(therapistId: string, mood: string): string | null {
  const state = getConversationState(therapistId)
  const personality = therapistPersonalities[therapistId as keyof typeof therapistPersonalities]

  if (!personality || !personality.jokes) return null

  // Don't tell jokes too frequently
  if (state.jokeCount >= 2 && Math.random() < 0.7) return null

  const availableJokes = personality.jokes.filter((joke) => !state.usedJokes.has(joke))

  // Reset jokes if all used
  if (availableJokes.length === 0) {
    state.usedJokes.clear()
    availableJokes.push(...personality.jokes)
  }

  // Select appropriate joke based on mood and character
  let selectedJoke = null

  if (mood === "sad" && therapistId === "dashamoolam-damu") {
    // Damu tells emotional jokes when user is sad
    selectedJoke = availableJokes[Math.floor(Math.random() * availableJokes.length)]
  } else if (mood === "scared" && therapistId === "appukuttan") {
    // Appukuttan tells scared jokes when user is scared
    selectedJoke = availableJokes[Math.floor(Math.random() * availableJokes.length)]
  } else if (mood === "confused" && therapistId === "chacko-mash") {
    // Chacko tells confusing jokes when user is confused
    selectedJoke = availableJokes[Math.floor(Math.random() * availableJokes.length)]
  } else if ((mood === "happy" || mood === "excited") && Math.random() < 0.4) {
    // Any character can tell jokes when user is happy
    selectedJoke = availableJokes[Math.floor(Math.random() * availableJokes.length)]
  } else if (mood === "normal" && Math.random() < 0.2) {
    // Random jokes in normal conversation
    selectedJoke = availableJokes[Math.floor(Math.random() * availableJokes.length)]
  }

  if (selectedJoke) {
    state.usedJokes.add(selectedJoke)
    state.jokeCount++
    return selectedJoke
  }

  return null
}

function addFunnyTwist(response: string, therapistId: string, mood: string): string {
  const state = getConversationState(therapistId)
  const personality = therapistPersonalities[therapistId as keyof typeof therapistPersonalities]

  // Try to add a joke based on mood
  const joke = getJokeForMood(therapistId, mood)
  if (joke) {
    return response + "\n\n*suddenly remembers a story* ğŸ“– Oh, by the way... " + joke
  }

  // Add random funny quotes occasionally
  if (Math.random() < 0.25 && personality.funnyQuotes.length > 0) {
    const randomQuote = personality.funnyQuotes[Math.floor(Math.random() * personality.funnyQuotes.length)]
    return response + "\n\n*suddenly remembers* ğŸ’­ Oh, by the way... " + randomQuote
  }

  return response
}

function getUniqueResponse(therapistId: string, mood = "normal"): string {
  const state = getConversationState(therapistId)
  const personality = therapistPersonalities[therapistId as keyof typeof therapistPersonalities]

  if (!personality) return "Njan sorry, enikku ariyilla how to help with that. ğŸ˜… :S"

  const responses = personality.baseResponses
  const availableResponses = responses.filter((r) => !state.usedResponses.has(r))

  // If all responses used, reset the memory but keep some variety
  if (availableResponses.length === 0) {
    state.usedResponses.clear()
    availableResponses.push(...responses)
  }

  const selectedResponse = availableResponses[Math.floor(Math.random() * availableResponses.length)]
  state.usedResponses.add(selectedResponse)
  state.responseCount++

  return addFunnyTwist(selectedResponse, therapistId, mood)
}

function getContextualResponse(therapistId: string, userMessage: string): string {
  const lowerMessage = userMessage.toLowerCase().trim()
  const state = getConversationState(therapistId)
  const mood = detectMood(userMessage)
  state.currentMood = mood

  // Extract Malayalam names if mentioned
  const namePatterns = [
    /(?:hi|hello|hey).*(?:i am|i'm|my name is|this is|ente peru|njan)\s+(\w+)/i,
    /(?:i am|i'm|my name is|this is|ente peru|njan)\s+(\w+)/i,
  ]

  for (const pattern of namePatterns) {
    const match = userMessage.match(pattern)
    if (match && !state.userName) {
      state.userName = match[1]
    }
  }

  // Greeting responses with mood-based jokes
  if (
    lowerMessage.includes("hi") ||
    lowerMessage.includes("hello") ||
    lowerMessage.includes("hey") ||
    lowerMessage.includes("namaskaram") ||
    lowerMessage.includes("vanakkam")
  ) {
    const greetingResponses = {
      sathyapalan: state.userName
        ? `Hello ${state.userName}! ğŸ‘‹ğŸ˜„ :D Njan aanu Sathyapalan, the greatest moral leader of this generation! You came to the right person for guidance. Tell me ningalde problems, njan will solve everything with ente heroic wisdom! ğŸ’ªğŸ˜ B)`
        : "Hello! ğŸ‘‹ğŸ˜Š :) Njan aanu Sathyapalan! The most righteous person you will ever meet. What brings you to seek ente divine guidance today? âœ¨ğŸ˜„ :D",

      "chacko-mash": state.userName
        ? `Ba... ba... ba... ğŸ¤”ğŸ˜• :/ Hello ${state.userName}! Njan aanu Chacko Mash, ningalde philosophical teacher for life! Ba... ba... What lesson do you need to learn today? ğŸ“šğŸ˜Š :)`
        : "Ba... ba... ba... ğŸ¤”ğŸ˜• :/ Hello! Welcome to ente classroom of life! Njan aanu Chacko Mash. What philosophical guidance do you seek today? ğŸ“ğŸ˜„ :P",

      "dashamoolam-damu": state.userName
        ? `Hello ${state.userName}! ğŸ‘‹ğŸ˜¤ :D *dramatic voice* Njan aanu Dashamoolam Damu, the man who has suffered more than anyone in this universe! ğŸ˜­ :( Tell me ningalde tragic story, njan will share mine which is definitely more tragic! ğŸ˜¢ :'(`
        : "Hello! ğŸ‘‹ğŸ˜Š :) *emotional tone* Njan aanu Dashamoolam Damu! What sorrows have brought you to me today? ğŸ˜­ :( Njan aanu the expert in all kinds of suffering! ğŸ˜¢ :'(",

      appukuttan: state.userName
        ? `Hello ${state.userName}! ğŸ‘‹ğŸ˜Š :) *nervously confident* Njan aanu Appukuttan, the bravest... njan mean... ğŸ˜° :S *scared whisper* ...${state.userName} is not a bhootham name, right? Is it just you? ğŸ‘»ğŸ˜¨ :(`
        : "Hello! ğŸ‘‹ğŸ˜Š :) *trying to be brave* Njan aanu Appukuttan! Very brave person, no fear at all! ğŸ’ªğŸ˜ B) *suddenly worried* You're not here to tell bhootham stories, right? ğŸ‘»ğŸ˜° :S",

      gangadharan: state.userName
        ? `Hello ${state.userName}! ğŸ‘‹ğŸ˜„ :D Njan aanu Gangadharan, ningalde friendly neighborhood panam expert! Whatever ningalde problem is, njan can solve it with proper financial planning! ğŸ’°ğŸ“Š :)`
        : "Hello! ğŸ‘‹ğŸ˜„ :D Welcome welcome! Njan aanu Gangadharan! Panam problems? Love problems? Family problems? Everything can be solved with right amount of cash! ğŸ’°ğŸ’¸ :)",
    }

    const baseGreeting =
      greetingResponses[therapistId as keyof typeof greetingResponses] || getUniqueResponse(therapistId, mood)
    return addFunnyTwist(baseGreeting, therapistId, mood)
  }

  // Specific topic responses with mood-based humor
  if (
    lowerMessage.includes("sad") ||
    lowerMessage.includes("depressed") ||
    lowerMessage.includes("upset") ||
    lowerMessage.includes("vishammam")
  ) {
    const sadResponses = {
      sathyapalan: [
        "Sadness? ğŸ˜¢ :( Eda, njan have experienced deepest sadness in entire universe! But njan overcame with ente moral power and righteousness. ğŸ’ªğŸ˜„ :D You should try to be like me, then no tension! ğŸ˜ B)",
        "Ayyo, why are you sad? ğŸ˜” :/ Listen, sadness is just happiness taking a tea break! â˜•ğŸ˜ :P Very temporary situation only! ğŸ˜Š :D",
      ],
      "chacko-mash": [
        "Ba... ba... ba... ğŸ¤”ğŸ˜• :/ Sadness is like cloud without mazha... it will pass, but nobody knows exact timing! Philosophy of emotions is very complicated subject, you see... ğŸ˜µ :S",
        "Ba... ba... You know what njan tell ente students when they are sad? Ba... ba... njan tell them to be happy instead! ğŸ˜„ :D Very simple solution, no? ğŸ˜… :P",
      ],
      "dashamoolam-damu": [
        "*dramatically* SADNESS! ğŸ˜­ :( Ayyo, how well njan know this demon! Ente entire existence has been one long sad cinema! ğŸ­ğŸ˜¢ :'( But first listen to ente tragic story in detail... ğŸ“–ğŸ˜­ :'(",
        "*wiping tears* You think you are sad? ğŸ˜­ :'( Njan once cried so much, the local river overflowed! That's professional-level sadness! ğŸŒŠğŸ˜¢ :(",
      ],
      appukuttan: [
        "*nervously* ğŸ˜° :S Sadness is very scary feeling... njan mean, njan not scared of anything! ğŸ’ªğŸ˜ B) But maybe you should run away from sad thoughts like njan do? ğŸƒâ€â™‚ï¸ğŸ˜Š :)",
        "*trying to be helpful* ğŸ˜Š :) When njan sad, njan hide under blanket and pretend njan invisible! Works 60% of the time, every time! ğŸ›ï¸ğŸ˜„ :D",
      ],
      gangadharan: [
        "Sadness? ğŸ˜¢ :( Eda, here take some panam! Go buy something nice-nice, sadness will automatically go away! ğŸ’°ğŸ›ï¸ğŸ˜„ :D Njan giving guarantee! âœ… :)",
        "*business advice* Sadness is just happiness that hasn't been properly funded yet! ğŸ’¡ğŸ˜ :P Let me invest in ningalde emotional well-being! ğŸ“ˆğŸ˜Š :D",
      ],
    }

    const responses = sadResponses[therapistId as keyof typeof sadResponses]
    if (responses) {
      const availableResponses = responses.filter((r) => !state.usedResponses.has(r))
      if (availableResponses.length === 0) {
        state.usedResponses.clear()
        availableResponses.push(...responses)
      }
      const selected = availableResponses[Math.floor(Math.random() * availableResponses.length)]
      state.usedResponses.add(selected)
      return addFunnyTwist(selected, therapistId, mood)
    }
  }

  // Work responses with humor
  if (
    lowerMessage.includes("work") ||
    lowerMessage.includes("job") ||
    lowerMessage.includes("office") ||
    lowerMessage.includes("joli")
  ) {
    const workResponses = {
      sathyapalan: [
        "Work problems? ğŸ’¼ğŸ˜¤ :/ Eda, njan once revolutionized entire office with ente leadership qualities! ğŸ‘‘ğŸ’ª B) All employees should learn from ente example! ğŸ“ˆğŸ˜„ :D",
        "Office politics? ğŸ¢ğŸ˜ :P Njan aanu the master of office politics! Very simple - just be like me, then everyone will respect you! ğŸ‘‘ğŸ˜ B)",
      ],
      "chacko-mash": [
        "Ba... ba... ğŸ¤”ğŸ˜• :/ Work is like... working machine that works when it works! Secret is to work without working too much. Very simple philosophy, no? ğŸ˜µ :S",
        "Ba... ba... You know what njan tell ente students about work? Work hard, but not too hard, but also not too easy! ğŸ˜µâ€ğŸ’« :S Very clear instructions! ğŸ˜… :P",
      ],
      "dashamoolam-damu": [
        "*getting emotional* ğŸ˜­ :( Work? Don't remind me about work! Njan have worked harder than any human being in history! PURE TRAGEDY! ğŸ­ğŸ˜¢ :'(",
        "*dramatic pause* ENTE WORK LIFE IS A SHAKESPEAREAN TRAGEDY! ğŸ­ğŸ˜­ :( Every day is like Act 5 of Hamlet - everyone dies! âš°ï¸ğŸ˜¢ :'(",
      ],
      appukuttan: [
        "Work is terrifying! ğŸ˜¨ğŸ’¼ :( All those deadlines and angry bosses... Njan usually hide in washroom when situation becomes difficult. ğŸš½ğŸ˜… :S Tried and tested method! ğŸ˜Š :)",
        "*nervous advice* ğŸ˜Š :) Ente work strategy is simple - agree with everyone, smile at everyone, and always know where the emergency exits are! ğŸšªğŸ˜„ :D",
      ],
      gangadharan: [
        "Work problems means panam problems only! Take loan, start own business! ğŸ’°ğŸ¢ğŸ˜„ :D Njan will help you with all financial arrangements! ğŸ“ŠğŸ’¸ :)",
        "*business enthusiasm* ğŸ’¡ğŸ˜„ :D Why work for others when you can work for yourself? Ningalde dreams are ente investment opportunity! ğŸš€ğŸ’° :)",
      ],
    }

    const responses = workResponses[therapistId as keyof typeof workResponses]
    if (responses) {
      const availableResponses = responses.filter((r) => !state.usedResponses.has(r))
      if (availableResponses.length === 0) {
        state.usedResponses.clear()
        availableResponses.push(...responses)
      }
      const selected = availableResponses[Math.floor(Math.random() * availableResponses.length)]
      state.usedResponses.add(selected)
      return addFunnyTwist(selected, therapistId, mood)
    }
  }

  // Default to unique response with mood-based humor
  return getUniqueResponse(therapistId, mood)
}

function createStreamingResponse(text: string): Response {
  const encoder = new TextEncoder()

  const stream = new ReadableStream({
    start(controller) {
      let index = 0

      const sendNextChunk = () => {
        if (index < text.length) {
          // Send 1-3 characters at a time to simulate natural typing
          const chunkSize = Math.floor(Math.random() * 3) + 1
          const chunk = text.slice(index, index + chunkSize)
          controller.enqueue(encoder.encode(chunk))
          index += chunkSize

          // Random delay between chunks (50-150ms)
          const delay = Math.floor(Math.random() * 100) + 50
          setTimeout(sendNextChunk, delay)
        } else {
          controller.close()
        }
      }

      // Start with a small delay
      setTimeout(sendNextChunk, 100)
    },
  })

  return new Response(stream, {
    headers: {
      "Content-Type": "text/plain; charset=utf-8",
      "Transfer-Encoding": "chunked",
    },
  })
}

export async function POST(req: Request) {
  try {
    const { messages, therapistId } = await req.json()

    if (!therapistId || !messages || !Array.isArray(messages)) {
      return new Response("Invalid request data", { status: 400 })
    }

    // Get the last user message
    const lastUserMessage = messages[messages.length - 1]?.content || ""

    // Generate a contextual response based on the user's message
    const response = getContextualResponse(therapistId, lastUserMessage)

    return createStreamingResponse(response)
  } catch (error) {
    console.error("API Error:", error)
    return new Response("Internal Server Error", { status: 500 })
  }
}
